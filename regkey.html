<!DOCTYPE html>
<html lang="en-GB">

	<head>
		<title>Hyperphase Key Registrar</title>
	</head>
	<button id="button">Register New Key</button>
	<script type="text/javascript" src="resources/scripts/u2f-api.js"></script>
	<script type="text/javascript">
		function httpGetAsync(theUrl, callback) {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.onreadystatechange = function () {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
					callback(xmlHttp.responseText);
			}
			xmlHttp.open("GET", theUrl, true); // true for asynchronous
			xmlHttp.send(null);
		}
		function httpPostAsync(theUrl, theData, callback) {
			var xmlHttp = new XMLHttpRequest();
			xmlHttp.setRequestHeader('Content-type', 'application/json;charset=UTF-8');
			xmlHttp.onreadystatechange = function () {
				if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
					callback(xmlHttp.responseText);
			}
			xmlHttp.open("POST", theUrl, true); // true for asynchronous
			xmlHttp.send(JSON.stringify(theData));
		}
		window.onload = function () {
			document.getElementById('button').onclick = function () {
				httpGetAsync('https://hyperphase.app/newkey', function (registrationRequest) {
					var registrationRequest = JSON.parse(registrationRequest);
					console.log(registrationRequest);
					let credential = navigator.credentials.create({
						publicKey: {
							challenge: new TextEncoder().encode(registrationRequest.challenge.toString()),
							rp: { id: "hyperphase.app", name: "Hyperphase" },
							user: {
								id: new TextEncoder().encode(registrationRequest.challenge.toString()),
								name: "thetimekeeper@hyperphase.app",
								displayName: "The Timekeeper"
							},
							pubKeyCredParams: [{ type: "public-key", alg: -7 }]
						}
					}).then(function (data) {
						httpPostAsync('https://hyperphase.app/verifynewkey', JSON.stringify(data), function (response_data) {
							console.log(response_data);
						});
					}).catch(function (error) {
						console.error(error);
					});
				});
			}
		}
	</script>

</html>